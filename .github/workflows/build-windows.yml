name: Build Video Trimmer for Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4.7.1
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      
    - name: Download FFmpeg
      run: |
        python download_ffmpeg.py
      
    - name: Build application
      run: |
        pyinstaller build_app.spec
      
    - name: Verify build output
      run: |
        dir builds\VideoTrimmer
        dir builds\VideoTrimmer\icons
      
    - name: Create icons directory if missing
      run: |
        if (-not (Test-Path -Path "builds\VideoTrimmer\icons")) {
          New-Item -ItemType Directory -Force -Path "builds\VideoTrimmer\icons"
        }
      
    - name: Copy icons to build directory
      run: |
        Copy-Item -Path "icons\*" -Destination "builds\VideoTrimmer\icons\" -Recurse -Force
      
    - name: Create zip archive
      run: |
        $system = [System.Environment]::OSVersion.Platform
        $arch = [System.Environment]::GetEnvironmentVariable("PROCESSOR_ARCHITECTURE")
        $zipName = "VideoTrimmer_Windows_$arch"
        
        # Change to parent directory containing the builds folder
        Set-Location $env:GITHUB_WORKSPACE
        
        # Create zip file containing the entire VideoTrimmer directory
        Compress-Archive -Path "builds\VideoTrimmer\*" -DestinationPath "$zipName.zip" -Force
        
        # Verify the contents of the zip
        Write-Output "Created zip file: $zipName.zip"
        Get-ChildItem "$zipName.zip"

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: VideoTrimmer-Windows
        path: builds/VideoTrimmer/
        
    - name: Upload zip artifact
      uses: actions/upload-artifact@v4
      with:
        name: VideoTrimmer-Windows-Zip
        path: VideoTrimmer_Windows_*.zip